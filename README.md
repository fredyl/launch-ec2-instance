def replace_null_values_df(data_key):
    if isinstance (data_key, dict):
        return {k: replace_null_values_df(v) if v is not None else " " for k, v in data_key.items()}
    elif isinstance (data_key, list):
        return [replace_null_values_df(item) if item is not None else " " for item in data_key]
    else:
        return data_key if data_key is not None else " "



def generate_paginated_urls(data_type,data_key, code_key, code_value,total_pages,batch_size=200):
    base_url = "https://customer-experience-api.arifleet.com/v1/"
    pagination_urls = []
    num_batches = (total_pages // batch_size) + 1
    print(f" num_batches : {num_batches}")
    for i in range(num_batches):
        for page in range(i * batch_size + 1, min((i + 1) * batch_size + 1, total_pages +1)):
            url = f"{base_url}{data_type}?{code_key}={code_value}&pageNumber={page}"
            pagination_urls.append({"pageNumber": page, "url": url})
            # print(pagination_urls)
    print('len', len(pagination_urls))
    return pagination_urls, num_batches


holman_endpoints = {
    "vehicles": ("inventory", "clientVehicleNumber"),
    "maintenance": ("maintenance", "clientVehicleNumber"),
    "accidents": ("accident", "record_id"),
    "odometer": ("odometerHistory", "vin"),
    "persons": ("person", "contactEmployeeId")
}

#iterate through the endpoints to fetch and upsert data
for data_type, (data_key, primary_key) in holman_endpoints.items():
    data_list = get_holman_data(token, data_type=data_type, data_key=data_key)
    data_list = replace_null_values(data_list)
    # print(json.dumps(data_list, indent=4))
    if data_list:
        Holman_Upsert_data(data_type, data_key, data_list, primary_key)
    else:
        print(f"No data found for {data_type}_{data_key}")
print("All data fetched")


data_type="orders" 
data_key="orderHistory"
primary_key="clientVehicleNumber"
merge_keys= ["clientVehicleNumber", "upfitPoIssueDate","tg_updated"]  
table_name = f"bronze.holman_{data_type}_{data_key}"
print(table_name)

data_list = get_holman_data(token, data_type =data_type, data_key=data_key)
df = spark.createDataFrame(data_list)
current_time = current_timestamp()
df = df.withColumn("tg_inserted", current_time).withColumn("tg_updated", current_time)
if spark.catalog.tableExists(table_name):
    print(f"Table {table_name} exists. Performing upsert (merge)...")
    delta_table = DeltaTable.forName(spark, table_name)
    merge_condition = " AND " .join([f"new_data.{primary_key} = existing_data.{primary_key}" for primary_key in merge_keys])
    delta_table.alias("existing_data") \
        .merge(
            df.alias("new_data"), expr(merge_condition)
        ) \
        .whenMatchedUpdate(
            set={
                **{col_name: col(f"new_data.{col_name}") for col_name in df.columns if col_name != primary_key and col_name != "tg_inserted"},
                "tg_updated": current_time
            }
        ) \
        .whenNotMatchedInsertAll() \
        .execute()
    print(f"Upsert completed for {table_name}")
else:
    print(f"Table does not exist, creating new table {table_name}")
    df.write.format("delta").saveAsTable(table_name)






    ariVehicleNumber	ataCode	ataDescription	auxData1	auxData10	auxData11	auxData12	auxData13	auxData14	auxData2	auxData3	auxData4	auxData5	auxData6	auxData7	auxData8	auxData9	auxDate1	auxDate2	auxDate3	auxDate4	billPaidDate	cause	clientData1	clientData2	clientData3	clientData4	clientData5	clientData6	clientData7	clientVehicleNumber	complaint	cost	customerPoNumber	division	driverClass	exec	firstName	hourMeter	invoiceDate	invoiceNumber	lastName	lesseeCode	odometer	parentVendor	poDate	poDetailsId	poNumber	poTotalLineCost	prefix	quantity	record_id	repairDate	type	vendorAddressLine1	vendorAddressLine2	vendorCity	vendorId	vendorName	vendorStateProvince	vendorType	vendorZipPostalCode	vin	tg_inserted	tg_updated
02914V	17000000	TIRES, TUBES, LINERS & VALVES	TGC-27C		TRAILER				UTILITY							TRAILER	8/31/2012				9/11/2024 11:30	NOT SUPPLIED	TRAILER			9051	9102	MARIETTA	57729999	T47127	SERVICE CALL	322	7611294	TG		Y	BRANCH		9/11/2024 11:30	7611294	MANAGER	5DA4	0	 	9/11/2024 11:30	560926375	107618377	322	5772	1	640674609	9/11/2024 11:27	L	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMUL1822DG002914	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
02914V	17000000	TIRES, TUBES, LINERS & VALVES	TGC-27C		TRAILER				UTILITY							TRAILER	8/31/2012				9/11/2024 11:30	NOT SUPPLIED	TRAILER			9051	9102	MARIETTA	57729999	T47127	NOT SUPPLIED	125	7611294	TG		Y	BRANCH		9/11/2024 11:30	7611294	MANAGER	5DA4	0	 	9/11/2024 11:30	560926377	107618377	250	5772	2	640642721	9/11/2024 11:27	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMUL1822DG002914	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
02914V	17001002	TIRE, RADIAL  RIB TREAD	TGC-27C		TRAILER				UTILITY							TRAILER	8/31/2012				9/11/2024 11:30	NOT SUPPLIED	TRAILER			9051	9102	MARIETTA	57729999	T47127	NOT SUPPLIED	24	7611294	TG		Y	BRANCH		9/11/2024 11:30	7611294	MANAGER	5DA4	0	 	9/11/2024 11:30	560926376	107618377	24	5772	1	640619732	9/11/2024 11:27	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMUL1822DG002914	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
00683V	97001001	PRODUCT PUMP	TGC-24C		TRAILER				UTILITY							TRAILER	8/17/2012				9/16/2024 12:50	NOT SUPPLIED	TRAILER			9051	9114	WILLOUGHBY	57459999	T47118	NOT SUPPLIED	33.97	7616885	TG		Y	BRANCH		9/16/2024 12:50	7616885	MANAGER	5DA4	0	 	9/16/2024 12:50	561373124	107685507	33.97	5745	1	640647166	9/11/2024 12:47	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMUL1011DG000686	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
00683V	60004A07	WRK EQUIP, ANCHOR SPREADER	TGC-24C		TRAILER				UTILITY							TRAILER	8/17/2012				9/9/2024 11:42	NOT SUPPLIED	TRAILER			9051	9114	WILLOUGHBY	57459999	T47118	INSTALL RIGHT SIDE SPRING- UJO	342.9	7607599	TG		Y	BRANCH		9/9/2024 11:42	7607599	MANAGER	5DA4	0	 	9/9/2024 11:42	560606740	107569877	342.9	5745	1	640626158	9/5/2024 11:41	L	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMUL1011DG000686	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
00683V	97001001	PRODUCT PUMP	TGC-24C		TRAILER				UTILITY							TRAILER	8/17/2012				9/9/2024 11:42	NOT SUPPLIED	TRAILER			9051	9114	WILLOUGHBY	57459999	T47118	NOT SUPPLIED	24	7607599	TG		Y	BRANCH		9/9/2024 11:42	7607599	MANAGER	5DA4	0	 	9/9/2024 11:42	560606741	107569877	24	5745	1	640662317	9/5/2024 11:41	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMUL1011DG000686	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
00683V	60004A07	WRK EQUIP, ANCHOR SPREADER	TGC-24C		TRAILER				UTILITY							TRAILER	8/17/2012				9/16/2024 12:50	NOT SUPPLIED	TRAILER			9051	9114	WILLOUGHBY	57459999	T47118	TRAILER- INSTALL BATTERY BOX= 	485.4	7616885	TG		Y	BRANCH		9/16/2024 12:50	7616885	MANAGER	5DA4	0	 	9/16/2024 12:50	561373123	107685507	485.4	5745	1	640628391	9/11/2024 12:47	L	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMUL1011DG000686	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001A05	MOUNT & DISMOUNT			TRAILER				UTILITY							TRAILER	8/6/2012				8/12/2024 15:50	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	20	7572428	TG		Y	BRANCH		8/12/2024 15:50	7572428	MANAGER	5DA4	0	 	8/12/2024 15:50	557826090	107151768	40	5458	2	640648465	8/12/2024 14:02	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001A06	FLAT REPAIR			TRAILER				UTILITY							TRAILER	8/6/2012				8/12/2024 15:50	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	R&R 2 REAR TIRES- LEFT FRONT F	30	7572428	TG		Y	BRANCH		8/12/2024 15:50	7572428	MANAGER	5DA4	0	 	8/12/2024 15:50	557826089	107151768	30	5458	1	640676166	8/12/2024 14:02	L	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001A02	TIRE, DISPOSAL FEE			TRAILER				UTILITY							TRAILER	8/6/2012				8/19/2024 9:55	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	4	7580766	TG		Y	BRANCH		8/19/2024 9:55	7580766	MANAGER	5DA4	0	 	8/19/2024 9:55	558512211	107257202	16	5458	4	640648515	8/19/2024 9:53	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001A05	MOUNT & DISMOUNT			TRAILER				UTILITY							TRAILER	8/6/2012				8/19/2024 9:55	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	12.98	7580766	TG		Y	BRANCH		8/19/2024 9:55	7580766	MANAGER	5DA4	0	 	8/19/2024 9:55	558512214	107257202	51.92	5458	4	640625167	8/19/2024 9:53	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001A02	TIRE, DISPOSAL FEE			TRAILER				UTILITY							TRAILER	8/6/2012				8/12/2024 15:50	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	5	7572428	TG		Y	BRANCH		8/12/2024 15:50	7572428	MANAGER	5DA4	0	 	8/12/2024 15:50	557826093	107151768	10	5458	2	640653173	8/12/2024 14:02	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17000000	TIRES, TUBES, LINERS & VALVES			TRAILER				UTILITY							TRAILER	8/6/2012				8/30/2024 16:09	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	R&R 2 TIRES ON TRAILER AND 2 S	304.41	7598407	TG		Y	BRANCH		8/30/2024 16:09	7598407	MANAGER	5DA4	0	 	8/30/2024 16:09	559883826	107458628	304.41	5458	1	640676741	8/30/2024 16:07	L	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001A05	TIRE MOUNT & DISMOUNT			TRAILER				UTILITY							TRAILER	8/6/2012				9/13/2024 16:24	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	DISMOUNT AND MOUNT TIRE ON SPA	15.92	7615319	TG		Y	BRANCH		9/13/2024 16:24	7615319	MANAGER	5DA4	0	 	9/13/2024 16:24	561260621	107666996	15.92	5458	1	640655020	9/13/2024 16:22	L	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17008001	STEM - VALVE			TRAILER				UTILITY							TRAILER	8/6/2012				8/19/2024 9:55	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	5	7580766	TG		Y	BRANCH		8/19/2024 9:55	7580766	MANAGER	5DA4	0	 	8/19/2024 9:55	558512213	107257202	20	5458	4	640630219	8/19/2024 9:53	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	53999A13	SHOP SUPPLIES			TRAILER				UTILITY							TRAILER	8/6/2012				8/12/2024 15:50	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	4.9	7572428	TG		Y	BRANCH		8/12/2024 15:50	7572428	MANAGER	5DA4	0	 	8/12/2024 15:50	557826091	107151768	4.9	5458	1	640657202	8/12/2024 14:02	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	97001001	PRODUCT PUMP			TRAILER				UTILITY							TRAILER	8/6/2012				8/12/2024 15:50	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	102.6	7572428	TG		Y	BRANCH		8/12/2024 15:50	7572428	MANAGER	5DA4	0	 	8/12/2024 15:50	557826092	107151768	205.2	5458	2	640631318	8/12/2024 14:02	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001002	TIRE, RADIAL  RIB TREAD			TRAILER				UTILITY							TRAILER	8/6/2012				9/5/2024 9:42	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	61.53	7603505	TG		Y	BRANCH		9/5/2024 9:42	7603505	MANAGER	5DA4	0	 	9/5/2024 9:42	560294549	107519653	61.53	5458	1	640662733	9/5/2024 9:38	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29286V	17001002	TIRE, RADIAL  RIB TREAD			TRAILER				UTILITY							TRAILER	8/6/2012				8/19/2024 9:55	NOT SUPPLIED	TRAILER		LAWN	9051	9108	TULSA	54589999	T47105	NOT SUPPLIED	110.73	7580766	TG		Y	BRANCH		8/19/2024 9:55	7580766	MANAGER	5DA4	0	 	8/19/2024 9:55	558512212	107257202	442.92	5458	4	640664125	8/19/2024 9:53	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1423CT029286	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29870V	53999A13	SHOP SUPPLIES			TRAILER				UTILITY							TRAILER	8/3/2012				10/10/2024 12:39	NOT SUPPLIED	TRAILER			9051	9113	COLORADO SPR	57929999	T47093	NOT SUPPLIED	12	7650502	TG		Y	BRANCH		10/10/2024 12:39	7650502	MANAGER	5DA4	0	 	10/10/2024 12:39	564112978	108094935	12	5792	1	665815434	10/10/2024 12:37	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1429CM029870	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29870V	17001002	TIRE, RADIAL  RIB TREAD			TRAILER				UTILITY							TRAILER	8/3/2012				10/10/2024 12:39	NOT SUPPLIED	TRAILER			9051	9113	COLORADO SPR	57929999	T47093	NOT SUPPLIED	90.77	7650502	TG		Y	BRANCH		10/10/2024 12:39	7650502	MANAGER	5DA4	0	 	10/10/2024 12:39	564112976	108094935	90.77	5792	1	665823041	10/10/2024 12:37	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1429CM029870	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29870V	17001A05	MOUNT & DISMOUNT			TRAILER				UTILITY							TRAILER	8/3/2012				10/10/2024 12:39	NOT SUPPLIED	TRAILER			9051	9113	COLORADO SPR	57929999	T47093	NOT SUPPLIED	24	7650502	TG		Y	BRANCH		10/10/2024 12:39	7650502	MANAGER	5DA4	0	 	10/10/2024 12:39	564112979	108094935	24	5792	1	665823118	10/10/2024 12:37	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1429CM029870	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29870V	17001A02	TIRE, DISPOSAL FEE			TRAILER				UTILITY							TRAILER	8/3/2012				10/10/2024 12:39	NOT SUPPLIED	TRAILER			9051	9113	COLORADO SPR	57929999	T47093	NOT SUPPLIED	10	7650502	TG		Y	BRANCH		10/10/2024 12:39	7650502	MANAGER	5DA4	0	 	10/10/2024 12:39	564112977	108094935	10	5792	1	665824554	10/10/2024 12:37	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1429CM029870	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29870V	17001002	TIRE, RADIAL  RIB TREAD			TRAILER				UTILITY							TRAILER	8/3/2012				10/10/2024 12:39	NOT SUPPLIED	TRAILER			9051	9113	COLORADO SPR	57929999	T47093	NOT SUPPLIED	5.27	7650502	TG		Y	BRANCH		10/10/2024 12:39	7650502	MANAGER	5DA4	0	 	10/10/2024 12:39	564112975	108094935	5.27	5792	1	665826187	10/10/2024 12:37	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1429CM029870	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29870V	77012002	TRAILER FRAME (COMPLETE)			TRAILER				UTILITY							TRAILER	8/3/2012				10/21/2024 9:20	NOT SUPPLIED	TRAILER			9051	9113	COLORADO SPR	57929999	T47093	REPLACED PS TIRE ON TRAILER	128.54	7662917	TG		Y	BRANCH		10/21/2024 9:20	7662917	MANAGER	5DA4	0	 	10/21/2024 9:20	565079704	108247593	128.54	5792	1	688969664	10/18/2024 9:18	L	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1429CM029870	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
29870V	77001003	TRAILER CROSSMEMBER			TRAILER				UTILITY							TRAILER	8/3/2012				10/21/2024 9:20	NOT SUPPLIED	TRAILER			9051	9113	COLORADO SPR	57929999	T47093	NOT SUPPLIED	5.26	7662917	TG		Y	BRANCH		10/21/2024 9:20	7662917	MANAGER	5DA4	0	 	10/21/2024 9:20	565079705	108247593	5.26	5792	1	688973445	10/18/2024 9:18	P	1790 KIRBY PKWY		MEMPHIS	LVVGTLAUA	TRUGREEN	TN	HI	38138	4YMCL1429CM029870	2024-11-06T13:54:12.968Z	2024-11-06T13:54:12.968Z
![image](https://github.com/user-attachments/assets/17676da1-91d2-4bb7-a7d3-6974ed0e1c0b)

